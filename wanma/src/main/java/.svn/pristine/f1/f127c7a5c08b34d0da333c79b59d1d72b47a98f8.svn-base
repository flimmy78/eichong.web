<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- namespace必须指向Dao接口 -->

<mapper namespace="com.wanma.dao.CmsElectricPileMapper">
	<resultMap id="tblElectricpileResultMap" type="TblElectricpile">
		<id property="pkElectricpile" column="pk_ElectricPile" />
		<result property="elpiElectricpilename" column="elPi_ElectricPileName" />
		<result property="elpiElectricpilecode" column="elPi_ElectricPileCode" />
		<result property="elpiElectricpileaddress" column="elPi_ElectricPileAddress" />
		<result property="elpiLongitude" column="elPi_Longitude" />
		<result property="elpiLatitude" column="elPi_Latitude" />
		<result property="elpiPowernumber" column="elPi_PowerNumber" />
		<!-- <result property="elpiAreacode" column="elPi_AreaCode" /> -->
		<result property="elpiState" column="elPi_State" />
		<result property="elpiRejectionreason" column="elPi_RejectionReason" />
		<result property="elpiType" column="elPi_Type" />
		<result property="elpiPoweruser" column="elPi_PowerUser" />
		<result property="elpiChargingmode" column="elPi_ChargingMode" />
		<result property="elpiPowersize" column="elPi_PowerSize" />
		<result property="elpiPowerinterface" column="elPi_PowerInterface" />
		<result property="elpiMaker" column="elPi_Maker" />
		<result property="elPiOwnerCompany" column="elPi_OwnerCompany" />
		<!-- <result property="elpiImage" column="elPi_Image" /> <result property="elpiDetailimage" 
			column="elPi_DetailImage" /> -->
		<result property="elpiOutputvoltage" column="elPi_OutputVoltage" />
		<result property="elpiInputvoltage" column="elPi_InputVoltage" />
		<result property="elpiOutputcurrent" column="elPi_OutputCurrent" />
		<result property="elpiInputcurrent" column="elPi_InputCurrent" />
		<result property="elpiUsertype" column="elPi_UserType" />
		<result property="elpiUserid" column="elPi_UserId" />
		<result property="elpiCreatedate" column="elPi_Createdate" />
		<result property="elpiUpdatedate" column="elPi_Updatedate" />
		<result property="elpiRemark" column="elPi_Remark" />
		<result property="elpiCarid" column="elPi_Carid" />
		<result property="elpiBinding" column="elPi_Binding" />
		<result property="elpiIsappoint" column="elPi_IsAppoint" />
		<result property="elpiPaystyle" column="elPi_PayStyle" />
		<result property="elpiMaxelectricity" column="elPi_MaxElectricity" />
		<result property="elPiRelevancePowerStation" column="elPi_RelevancePowerStation" />
		<result property="elPi_ChargingModeName" column="elPi_ChargingModeName" />
		<result property="elPi_PowerUserName" column="elPi_PowerUserName" />
		<result property="elPi_Tell" column="elPi_Tell" />
		<result property="commStatus" column="comm_status" />
		<result property="elPiOnlineTime" column="elPi_OnlineTime" />
		<result property="elPiHaveConnectLine" column="have_Connect_Line" />
	</resultMap>
	<resultMap id="pageResultMap" type="java.util.HashMap"
		extends="tblElectricpileResultMap"></resultMap>
	<resultMap id="findResultMap" type="java.util.HashMap"
		extends="tblElectricpileResultMap"></resultMap>
	<resultMap id="findMap" type="java.util.HashMap"></resultMap>
	<select id="getEpCodesByRateId" parameterType="int" resultType="string">
		select elPi_ElectricPileCode from tbl_electricpile
		where elPi_State in
		(10,15) and comm_status=1 and elPi_RateInformationId = #{rateId} and
		elPi_ElectricPileCode &lt;&gt; ''
	</select>

	<select id="getElectricPileForList" parameterType="map"
		resultMap="findMap">
		select * from (
		select
		pk_PowerStation electricId,
		2 electricType,
		poSt_Name electricName,
		(select count(*) from tbl_ElectricPile where
		elPi_RelevancePowerStation =
		pk_PowerStation) electricPileSum,
		poSt_Address electricAddress,
		getFullPath('powerListImage',pk_PowerStation) as electricImage,
		poSt_PowerUser electricUse,
		null electriChargingMode,
		null
		electricPowerInterface,
		null electricPowerSize,
		null
		electricMaxElectricity,
		poSt_Longitude electricLongitude,
		poSt_Latitude
		electricLatitude,
		(SELECT count(*) FROM tbl_ElectricPile a,
		tbl_electricpilehead b WHERE
		a.pk_ElectricPile = b.pk_ElectricPile AND
		a.elPi_RelevancePowerStation
		= pk_PowerStation) headNum,
		(SELECT
		count(*) FROM tbl_ElectricPile a, tbl_electricpilehead b WHERE
		a.pk_ElectricPile = b.pk_ElectricPile AND a.elPi_RelevancePowerStation
		= pk_PowerStation AND b.ePHe_ElectricpileHeadState = 0) freeHeadNum,
		(select elPi_OwnerCompany from tbl_ElectricPile where
		elPi_RelevancePowerStation=pk_PowerStation limit 1) companyType,
		(select case when count(1)>0 then 15 else 10 end from tbl_ElectricPile
		where elPi_RelevancePowerStation=pk_PowerStation and elPi_State=15)
		electricState
		from
		tbl_PowerStation
		<where>
			poSt_Status in (10, 15)
			<if test="address != null and address != ''">
				and (poSt_Address like CONCAT('%','${address}','%' ) or
				poSt_Name like
				CONCAT('%','${address}','%' ) )
			</if>
			<if test="screenState != null and screenState != ''">
				and poSt_Status=#{screenState}
			</if>
			<if test="postIsappoint != null and postIsappoint != ''">
				and ps.poSt_IsAppoint=#{postIsappoint}
			</if>
			<if test="screenRadius != null">
				<!-- * mysql 通过两点经纬度，算两点之间距离(单位米) * 第一点经纬度：@lng1 @lat1 第二点经纬度：@lng2 @lat2 
					范例：round(6378.138*2*asin(sqrt(pow(sin( (@lat1*pi()/180-@lat2*pi()/180)/2),2)+cos(@lat1*pi()/180)*cos(@lat2*pi()/180)* 
					pow(sin( (@lng1*pi()/180-@lng2*pi()/180)/2),2)))*1000) 电桩查找 列表模式，距离排序 默认5km以内 -->
		             <![CDATA[ 
					       and round(6378.138*2*asin(sqrt(pow(sin( (#{latitude}*pi()/180-ps.poSt_Latitude*pi()/180)/2),2)+cos(#{latitude}*pi()/180)*cos(ps.poSt_Latitude*pi()/180)* 
		                                pow(sin( (#{longitude}*pi()/180-ps.poSt_Longitude*pi()/180)/2),2)))*1000)
							        <=#{screenRadius}
					       ]]>
			</if>
			and pk_PowerStation in (select elPi_RelevancePowerStation from
			tbl_electricpile a
			where elPi_State in (10, 15) and elPi_Binding=1
			<if test="headState != null and headState != ''">
				and a.pk_ElectricPile in(select pk_ElectricPile from
				tbl_electricpilehead where ePHe_ElectricpileHeadState=#{headState})
			</if>
			<if test="commStatus != null and commStatus != ''">
				and comm_Status = #{commStatus} and elPi_State =15
			</if>
			<if test="chargingMode != null and chargingMode!=''">
				and elPi_ChargingMode = #{chargingMode}
			</if>
			<if test="powerInterface != null  and powerInterface!=''">
				and elPi_PowerInterface = #{powerInterface}
			</if>
			<if test="screenType != null and screenType!=''">
				and (elPi_PowerUser=#{screenType} or elPi_PowerUser=13)
			</if>
			)
		</where>
		union all
		select
		a.pk_ElectricPile electricId,
		1 electricType,
		elPi_ElectricPileName electricName,
		null electricPileSum,
		elPi_ElectricPileAddress electricAddress,
		getFullPath('electricListImage',a.pk_ElectricPile) as electricImage,
		elPi_PowerUser electricUse,
		elPi_ChargingMode electriChargingMode,
		elPi_PowerInterface electricPowerInterface,
		elPi_PowerSize
		electricPowerSize,
		elPi_MaxElectricity electricMaxElectricity,
		elPi_Longitude electricLongitude,
		elPi_Latitude electricLatitude,
		(select count(*) from tbl_electricpilehead e where e.pk_ElectricPile =
		a.pk_ElectricPile) headNum,
		(select count(*) from tbl_electricpilehead
		e where e.pk_ElectricPile =
		a.pk_ElectricPile and
		e.ePHe_ElectricpileHeadState = 0) freeHeadNum,
		elPi_OwnerCompany
		companyType,
		elPi_State electricState

		from
		tbl_ElectricPile a
		<where>
			elPi_State in (10, 15) and elPi_Binding=0
			<if test="headState != null and headState != ''">
				and a.pk_ElectricPile in(select pk_ElectricPile from
				tbl_electricpilehead where ePHe_ElectricpileHeadState=#{headState})
			</if>
			<if test="commStatus != null and commStatus != ''">
				and comm_Status = #{commStatus} and elPi_State =15
			</if>
			<if test="address != null">
				and (elPi_ElectricPileAddress like
				CONCAT('%','${address}','%' ) or
				elPi_ElectricPileName like
				CONCAT('%','${address}','%' ) )
			</if>
			<if test="screenType != null and screenType != 0">
				and elPi_PowerUser=#{screenType}<!-- 电桩查找 列表模式，车辆类型 -->
			</if>
			<if test="chargingMode != null and chargingMode != ''">
				and elPi_ChargingMode=#{chargingMode}
			</if>
			<if test="screenState != null and screenState != ''">
				and elPi_State=#{screenState}
			</if>
			<if test="powerInterface != null and powerInterface != ''">
				and elPi_PowerInterface=#{powerInterface}
			</if>
		</where>
		) as electricPileList
		order by electricType desc
		<if test="pageNum!=null">limit #{pageNumber},#{pageNum}</if>
	</select>
	<select id="getElectricpileById" parameterType="map" resultType="hashmap">
		SELECT
		epl.pk_ElectricPile,
		epl.elPi_ElectricPileCode,
		epl.elPi_ElectricPileName,
		epl.ep_num,
		elPi_State,
		epl.elPi_PowerUser,
		epl.elPi_ChargingMode,
		cgt.coCo_Content elPi_PowerSize,
		epl.elPi_PowerInterface,
		getFullPath('electricListImage',epl.pk_ElectricPile) as elPiImage,
		epl.comm_status,
		(select SUM(e.total_charge_dl) from
		tbl_electricpilehead e where e.pk_ElectricPile = epl.pk_ElectricPile)
		totalChargeDl,
		(select SUM(e.total_charge_time) from
		tbl_electricpilehead e where e.pk_ElectricPile = epl.pk_ElectricPile)
		totalChargeTime,
		(select SUM(e.total_charge_amt) from
		tbl_electricpilehead e where e.pk_ElectricPile = epl.pk_ElectricPile)
		totalChargeAmt,
		epl.elPi_OnlineTime
		FROM
		tbl_ElectricPile epl left join
		tbl_configcontent cgt on
		epl.elPi_PowerSize = cgt.pk_ConfigContent
		WHERE epl.elPi_RelevancePowerStation = #{pkPowerstation}
	</select>
	<select id="getTblRateinformation" parameterType="String"
		resultType="hashmap">
		SELECT
		a.raIn_QuantumDate,
		a.raIn_TipTimeTariff,
		a.raIn_PeakElectricityPrice,
		a.raIn_UsualPrice,
		a.raIn_ValleyTimePrice,
		a.raIn_ServiceCharge
		FROM
		tbl_rateinformation a
		WHERE
		EXISTS (
		SELECT
		1
		FROM
		tbl_electricpile b
		WHERE
		b.pk_ElectricPile = #{value} and
		b.elPi_RateInformationId = a.pk_RateInformation
		)
	</select>
	<select id="findDetailById" parameterType="map" resultType="hashmap">
		select
		pk_ElectricPile pkElectricPile,
		elPi_PowerUser elPiPowerUser,
		elPi_ElectricPileName elPiElectricPileName,
		elPi_ElectricPileCode
		elPiElectricPileCode,
		elPi_ElectricPileAddress elPiElectricPileAddress,
		elPi_Longitude elPiLongitude,
		elPi_Latitude elPiLatitude,
		elPi_PowerNumber elPiPowerNumber,
		<!-- elPi_AreaCode elPiAreaCode, -->
		elPi_State elPiState,
		elPi_RejectionReason elPiRejectionReason,
		elPi_Type elPiType,
		elPi_PowerUser elPiPowerUser,
		elPi_ChargingMode
		elPiChargingMode,
		cgt.coCo_Content elPiPowerSize,
		elPi_PowerInterface
		elPiPowerInterface,
		elPi_Maker elPiMaker,
		elPi_OutputVoltage
		elPiOutputVoltage,
		elPi_InputVoltage elPiInputVoltage,
		elPi_OutputCurrent elPiOutputCurrent,
		elPi_InputCurrent
		elPiInputCurrent,
		elPi_UserType elPiUserType,
		elPi_UserId elPiUserId,
		elPi_Createdate elPiCreatedate,
		elPi_Updatedate elPiUpdatedate,
		elPi_Remark elPiRemark,
		elPi_Carid elPiCarid,
		elPi_Binding elPiBinding,
		elPi_IsAppoint elPiIsAppoint,
		elPi_PayStyle elPiPayStyle,
		elPi_MaxElectricity elPiMaxElectricity,
		elPi_Tell elPiTell,
		comm_status
		commStatus,
		elPi_OnlineTime elPiOnlineTime,
		(select
		SUM(e.total_charge_dl) from tbl_electricpilehead e where
		e.pk_ElectricPile = pst.pk_ElectricPile) totalChargeDl,
		(select
		SUM(e.total_charge_time) from tbl_electricpilehead e where
		e.pk_ElectricPile = pst.pk_ElectricPile) totalChargeTime,
		(select
		SUM(e.total_charge_amt) from tbl_electricpilehead e where
		e.pk_ElectricPile = pst.pk_ElectricPile) totalChargeAmt,
		getFullPath('electricListImage',pk_ElectricPile) as elPiImage,
		rate.raIn_ReservationRate raInReservationRate,
		rate.raIn_ServiceCharge
		raInServiceCharge
		from
		tbl_ElectricPile pst left join tbl_configcontent
		cgt on pst.elPi_PowerSize=cgt.pk_ConfigContent
		left join
		tbl_rateinformation rate on pst.elPi_RateInformationId =
		rate.pk_RateInformation
		where pk_ElectricPile=#{pkElectricpile}
	</select>

	<select id="getPileMonitorByUserId" parameterType="String"
		resultMap="tblElectricpileResultMap">
		SELECT
		t.charging_mode elPi_ChargingMode,
		t.power_interface
		elPi_PowerInterface
		FROM
		tbl_carinfo t
		WHERE t.pk_CarInfo = (SELECT
		u.norm_car_type_id FROM tbl_user_normal u
		WHERE u.user_id = #{value})
	</select>



	<select id="getElectricPileMonitorForList" parameterType="map"
		resultType="ElectricPileMonitor">
		select * from (
		select
		pk_PowerStation electricId,
		2 electricType,
		poSt_Name electricName,
		poSt_Address electricAddress,
		poSt_Longitude
		electricLongitude,
		poSt_Latitude electricLatitude,
		(case when not exists
		(select 1 from tbl_electricpile a where
		a.elPi_RelevancePowerStation =
		p.pk_PowerStation and a.comm_status =
		'1') then 0 else 1 end)
		pileStatus,
		(case when exists (select 1 from tbl_electricpile a where
		a.elPi_RelevancePowerStation = p.pk_PowerStation and exists (select 1
		from tbl_electricpilehead b where b.pk_ElectricPile =
		a.pk_ElectricPile and b.ePHe_ElectricpileHeadState = '0' and
		a.comm_status = '1')) then 1 end) isFree,
		(case when exists (select 1 from tbl_electricpile a where
		a.elPi_RelevancePowerStation = p.pk_PowerStation and exists (select 1
		from tbl_electricpilehead b where b.pk_ElectricPile =
		a.pk_ElectricPile and b.ePHe_ElectricpileHeadState = '0' and
		a.comm_status = '17')) then 1 end) isWait,
		(case when exists (select 1
		from tbl_electricpile a where
		a.elPi_RelevancePowerStation =
		p.pk_PowerStation and exists (select 1
		from tbl_electricpilehead b
		where b.pk_ElectricPile =
		a.pk_ElectricPile and
		b.ePHe_ElectricpileHeadState = '3' and
		a.comm_status = '1')) then 1
		end) isBespeak,
		(case when exists (select 1 from tbl_electricpile a
		where
		a.elPi_RelevancePowerStation = p.pk_PowerStation and exists
		(select 1
		from tbl_electricpilehead b where b.pk_ElectricPile =
		a.pk_ElectricPile and b.ePHe_ElectricpileHeadState = '6' and
		a.comm_status = '1')) then 1 end) isCharge,
		(case when exists (select 1
		from tbl_electricpile a where
		a.elPi_RelevancePowerStation =
		p.pk_PowerStation and exists (select 1
		from tbl_electricpilehead b
		where b.pk_ElectricPile =
		a.pk_ElectricPile and
		b.ePHe_ElectricpileHeadState = '9' and
		a.comm_status = '1')) then 1
		end) isError
		from
		tbl_PowerStation p
		<where>
			poSt_Status in (10, 15)
			<if test="pileName != null and pileName != ''">
				and poSt_Name like concat('%',#{pileName},'%')
			</if>
			and pk_PowerStation in (select elPi_RelevancePowerStation from
			tbl_electricpile a
			where elPi_State in (10, 15) and elPi_Binding=1
			<if test="headState != null and headState != ''">
				and a.pk_ElectricPile in(select pk_ElectricPile from
				tbl_electricpilehead where ePHe_ElectricpileHeadState=#{headState})
			</if>
			<!-- 权限控制 -->
			<choose>
				<when test="userLevel==3">
					and exists (select 1 from tbl_user_business_view b
					where
					b.user_id=a.elPi_UserId and exists (select 1 from
					tbl_user_business_view b1 where b.busi_company_id =
					b1.busi_company_id and b1.user_id = #{userId}))
				</when>
				<when test="userLevel==5">
					and a.elPi_UserId=#{userId}
				</when>
			</choose>
			<if test="electricSelProvince != null and electricSelProvince != ''">
				and elPi_OwnProvinceCode=#{electricSelProvince}
			</if>
			<if test="electricSelCity != null and electricSelCity != ''">
				and elPi_OwnCityCode=#{electricSelCity}
			</if>
			<if test="electricSelDistrict != null and electricSelDistrict != ''">
				and elPi_OwnCountyCode=#{electricSelDistrict}
			</if>

			)
		</where>
		union all
		select
		e.pk_ElectricPile electricId,
		1 electricType,
		elPi_ElectricPileName electricName,
		elPi_ElectricPileAddress
		electricAddress,
		elPi_Longitude electricLongitude,
		elPi_Latitude
		electricLatitude,
		comm_status pileStatus,
		(case when exists (select 1
		from tbl_electricpilehead a where
		a.pk_ElectricPile = e.pk_ElectricPile
		and a.ePHe_ElectricpileHeadState
		= '0') then 1 end) isFree,
		(case when exists (select 1
		from tbl_electricpilehead a where
		a.pk_ElectricPile = e.pk_ElectricPile
		and a.ePHe_ElectricpileHeadState
		= '17') then 1 end) isWait,
		(case when
		exists (select 1 from tbl_electricpilehead a where
		a.pk_ElectricPile =
		e.pk_ElectricPile and a.ePHe_ElectricpileHeadState
		= '3') then 1 end)
		isBespeak,
		(case when exists (select 1 from tbl_electricpilehead a
		where
		a.pk_ElectricPile = e.pk_ElectricPile and
		a.ePHe_ElectricpileHeadState
		= '6') then 1 end) isCharge,
		(case when
		exists (select 1 from tbl_electricpilehead a where
		a.pk_ElectricPile =
		e.pk_ElectricPile and a.ePHe_ElectricpileHeadState
		= '9') then 1 end)
		isError
		from
		tbl_ElectricPile e
		<where>
			elPi_State in (10, 15) and elPi_Binding=0
			<!-- 权限控制 -->
			<choose>
				<when test="userLevel==3">
					and exists (select 1 from tbl_user_business_view b
					where
					b.user_id=e.elPi_UserId and exists (select 1 from
					tbl_user_business_view b1 where b.busi_company_id =
					b1.busi_company_id and b1.user_id = #{userId}))
				</when>
				<when test="userLevel==5">
					and e.elPi_UserId=#{userId}
				</when>
			</choose>
			<if test="electricSelProvince != null and electricSelProvince != ''">
				and elPi_OwnProvinceCode=#{electricSelProvince}
			</if>
			<if test="electricSelCity != null and electricSelCity != ''">
				and elPi_OwnCityCode=#{electricSelCity}
			</if>
			<if test="electricSelDistrict != null and electricSelDistrict != ''">
				and elPi_OwnCountyCode=#{electricSelDistrict}
			</if>
			<if test="pileName != null and pileName != ''">
				and elPi_ElectricPileName like
				concat('%',#{pileName},'%')
			</if>
		</where>
		) as electricPileList
		order by electricType desc
		<if test="pager!=null">limit #{pager.begin},#{pager.count}</if>
	</select>


	<select id="getElectricPileMonitorForListCount" parameterType="map"
		resultType="long">
		select count(1) from (
		select
		pk_PowerStation electricId
		from
		tbl_PowerStation
		<where>
			poSt_Status in (10, 15)
			<if test="pileName != null and pileName != ''">
				and poSt_Name like concat('%',#{pileName},'%')
			</if>
			and pk_PowerStation in (select elPi_RelevancePowerStation from
			tbl_electricpile a
			where elPi_State in (10, 15) and elPi_Binding=1
			<!-- 权限控制 -->
			<choose>
				<when test="userLevel==3">
					and exists (select 1 from tbl_user_business_view b
					where
					b.user_id=a.elPi_UserId and exists (select 1 from
					tbl_user_business_view b1 where b.busi_company_id =
					b1.busi_company_id and b1.user_id = #{userId}))
				</when>
				<when test="userLevel==5">
					and a.elPi_UserId=#{userId}
				</when>
			</choose>
			<if test="electricSelProvince != null and electricSelProvince != ''">
				and elPi_OwnProvinceCode=#{electricSelProvince}
			</if>
			<if test="electricSelCity != null and electricSelCity != ''">
				and elPi_OwnCityCode=#{electricSelCity}
			</if>
			<if test="electricSelDistrict != null and electricSelDistrict != ''">
				and elPi_OwnCountyCode=#{electricSelDistrict}
			</if>
			<if test="headState != null and headState != ''">
				and a.pk_ElectricPile in(select pk_ElectricPile from
				tbl_electricpilehead where ePHe_ElectricpileHeadState=#{headState})
			</if>

			)
		</where>
		union all
		select
		a.pk_ElectricPile electricId

		from
		tbl_ElectricPile a
		<where>
			elPi_State in (10, 15) and elPi_Binding=0
			<!-- 权限控制 -->
			<choose>
				<when test="userLevel==3">
					and exists (select 1 from tbl_user_business_view b
					where
					b.user_id=a.elPi_UserId and exists (select 1 from
					tbl_user_business_view b1 where b.busi_company_id =
					b1.busi_company_id and b1.user_id = #{userId}))
				</when>
				<when test="userLevel==5">
					and a.elPi_UserId=#{userId}
				</when>
			</choose>
			<if test="headState != null and headState != ''">
				and a.pk_ElectricPile in(select pk_ElectricPile from
				tbl_electricpilehead where ePHe_ElectricpileHeadState=#{headState})
			</if>
			<if test="electricSelProvince != null and electricSelProvince != ''">
				and elPi_OwnProvinceCode=#{electricSelProvince}
			</if>
			<if test="electricSelCity != null and electricSelCity != ''">
				and elPi_OwnCityCode=#{electricSelCity}
			</if>
			<if test="electricSelDistrict != null and electricSelDistrict != ''">
				and elPi_OwnCountyCode=#{electricSelDistrict}
			</if>
			<if test="pileName != null and pileName != ''">
				and elPi_ElectricPileName like
				concat('%',#{pileName},'%')
			</if>
		</where>
		) as electricPileList
	</select>


	<select id="getElectricPileMonitorForListV2" parameterType="map"
		resultType="ElectricPileMonitor">
		select * from (
		select
		pk_PowerStation electricId,
		2 electricType,
		poSt_Name electricName,
		poSt_Address electricAddress,
		poSt_Longitude
		electricLongitude,
		(select elPi_OwnerCompany from tbl_electricpile
		where elPi_RelevancePowerStation=p.pk_PowerStation limit 1)
		elPiOwnerCompany,
		poSt_Latitude electricLatitude,
		(case when not exists
		(select 1 from tbl_electricpile a where
		a.elPi_RelevancePowerStation =
		p.pk_PowerStation and a.comm_status =
		'1') then 0 else 1 end)
		pileStatus,
		(case when exists (select 1 from tbl_electricpile a where
		a.elPi_RelevancePowerStation = p.pk_PowerStation and exists (select 1
		from tbl_electricpilehead b where b.pk_ElectricPile =
		a.pk_ElectricPile and b.ePHe_ElectricpileHeadState = '0' and
		a.comm_status = '1')) then 1 end) isFree,
		(case when exists (select 1 from tbl_electricpile a where
		a.elPi_RelevancePowerStation = p.pk_PowerStation and exists (select 1
		from tbl_electricpilehead b where b.pk_ElectricPile =
		a.pk_ElectricPile and b.ePHe_ElectricpileHeadState = '17' and
		a.comm_status = '1')) then 1 end) isWait,
		(case when exists (select 1
		from tbl_electricpile a where
		a.elPi_RelevancePowerStation =
		p.pk_PowerStation and exists (select 1
		from tbl_electricpilehead b
		where b.pk_ElectricPile =
		a.pk_ElectricPile and
		b.ePHe_ElectricpileHeadState = '3' and
		a.comm_status = '1')) then 1
		end) isBespeak,
		(case when exists (select 1 from tbl_electricpile a
		where
		a.elPi_RelevancePowerStation = p.pk_PowerStation and exists
		(select 1
		from tbl_electricpilehead b where b.pk_ElectricPile =
		a.pk_ElectricPile and b.ePHe_ElectricpileHeadState = '6' and
		a.comm_status = '1')) then 1 end) isCharge,
		(case when exists (select 1
		from tbl_electricpile a where
		a.elPi_RelevancePowerStation =
		p.pk_PowerStation and exists (select 1
		from tbl_electricpilehead b
		where b.pk_ElectricPile =
		a.pk_ElectricPile and
		b.ePHe_ElectricpileHeadState = '9' and
		a.comm_status = '1')) then 1
		end) isError
		from
		tbl_PowerStation p
		<where>
			poSt_Status in (10, 15)
			<if test="pileName != null and pileName != ''">
				and (poSt_Name like concat('%',#{pileName},'%') or
				poSt_Address like
				concat('%',#{pileName},'%'))
			</if>
			and pk_PowerStation in (select elPi_RelevancePowerStation from
			tbl_electricpile a
			where elPi_State in (10, 15) and elPi_Binding=1
			<if test="headStateStr != '999'">
				and exists (select 1 from tbl_electricpilehead p where
				p.pk_ElectricPile=a.pk_ElectricPile and
				FIND_IN_SET(p.ePHe_ElectricpileHeadState,#{headStateStr}))
				and
				a.comm_status = '1'
			</if>
			<if test="headState != null and headState != ''">
				and a.pk_ElectricPile in(select pk_ElectricPile from
				tbl_electricpilehead where ePHe_ElectricpileHeadState=#{headState})
			</if>
			<!-- 权限控制 -->
			<choose>
				<when test="userLevel==3">
					and exists (select 1 from tbl_user_business_view b
					where
					b.user_id=a.elPi_UserId and exists (select 1 from
					tbl_user_business_view b1 where b.busi_company_id =
					b1.busi_company_id and b1.user_id = #{userId}))
				</when>
				<when test="userLevel==5">
					and a.elPi_UserId=#{userId}
				</when>
			</choose>
			<if test="elPi_OwnCityCode != null and elPi_OwnCityCode != ''">
				and (elPi_OwnCityCode=#{elPi_OwnCityCode} or
				elPi_OwnProvinceCode =
				#{elPi_OwnCityCode})
			</if>
			)

			<if test="pileStatus != '999'">
				and pk_PowerStation not in (select
				elPi_RelevancePowerStation from
				tbl_electricpile a
				where elPi_State in
				(10, 15) and elPi_Binding=1
				and a.comm_status = '1'
				)
			</if>
		</where>
		union all
		select
		e.pk_ElectricPile electricId,
		1 electricType,
		elPi_ElectricPileName electricName,
		elPi_ElectricPileAddress
		electricAddress,
		elPi_Longitude electricLongitude,
		elPi_OwnerCompany,
		elPi_Latitude electricLatitude,
		comm_status pileStatus,
		(case when
		exists (select 1
		from tbl_electricpilehead a where
		a.pk_ElectricPile =
		e.pk_ElectricPile
		and a.ePHe_ElectricpileHeadState
		= '0') then 1 end)
		isFree,
		(case when
		exists (select 1 from tbl_electricpilehead a where
		a.pk_ElectricPile =
		e.pk_ElectricPile and a.ePHe_ElectricpileHeadState
		= '17') then 1 end)
		isWait,
		(case when
		exists (select 1 from tbl_electricpilehead a where
		a.pk_ElectricPile =
		e.pk_ElectricPile and a.ePHe_ElectricpileHeadState
		= '3') then 1 end)
		isBespeak,
		(case when exists (select 1 from
		tbl_electricpilehead a
		where
		a.pk_ElectricPile = e.pk_ElectricPile and
		a.ePHe_ElectricpileHeadState
		= '6') then 1 end) isCharge,
		(case when
		exists (select 1 from tbl_electricpilehead a where
		a.pk_ElectricPile =
		e.pk_ElectricPile and a.ePHe_ElectricpileHeadState
		= '9') then 1 end)
		isError
		from
		tbl_ElectricPile e
		<where>
			elPi_State in (10, 15) and elPi_Binding=0
			<!-- 权限控制 -->
			<choose>
				<when test="userLevel==3">
					and exists (select 1 from tbl_user_business_view b
					where
					b.user_id=e.elPi_UserId and exists (select 1 from
					tbl_user_business_view b1 where b.busi_company_id =
					b1.busi_company_id and b1.user_id = #{userId}))
				</when>
				<when test="userLevel==5">
					and e.elPi_UserId=#{userId}
				</when>
			</choose>
			<if test="elPi_OwnCityCode != null and elPi_OwnCityCode != ''">
				and (elPi_OwnCityCode=#{elPi_OwnCityCode} or
				elPi_OwnProvinceCode =
				#{elPi_OwnCityCode})
			</if>
			<if test="pileName != null and pileName != ''">
				and (elPi_ElectricPileName like
				concat('%',#{pileName},'%') or
				elPi_ElectricPileAddress like
				concat('%',#{pileName},'%'))
			</if>
			<if test="headStateStr != '999'">
				and exists (select 1 from tbl_electricpilehead p where
				p.pk_ElectricPile=e.pk_ElectricPile and
				FIND_IN_SET(p.ePHe_ElectricpileHeadState,#{headStateStr}))
				and
				e.comm_status = '1'
			</if>
			<if test="pileStatus != '999'">
				and e.comm_status = #{pileStatus}
			</if>
		</where>
		) as electricPileList
		order by electricType desc
		<if test="pager!=null">limit #{pager.begin},#{pager.count}</if>
	</select>



	<select id="getElectricPileMonitorForListV2Count" parameterType="map"
		resultType="long">
		select count(1) from (
		select 1
		from
		tbl_PowerStation p
		<where>
			poSt_Status in (10, 15)
			<if test="pileName != null and pileName != ''">
				and (poSt_Name like concat('%',#{pileName},'%') or
				poSt_Address like
				concat('%',#{pileName},'%'))
			</if>
			and pk_PowerStation in (select elPi_RelevancePowerStation from
			tbl_electricpile a
			where elPi_State in (10, 15) and elPi_Binding=1
			<if test="headStateStr != '999'">
				and exists (select 1 from tbl_electricpilehead p where
				p.pk_ElectricPile=a.pk_ElectricPile and
				FIND_IN_SET(p.ePHe_ElectricpileHeadState,#{headStateStr}))
				and
				a.comm_status = '1'
			</if>
			<if test="headState != null and headState != ''">
				and a.pk_ElectricPile in(select pk_ElectricPile from
				tbl_electricpilehead where ePHe_ElectricpileHeadState=#{headState})
			</if>
			<!-- 权限控制 -->
			<choose>
				<when test="userLevel==3">
					and exists (select 1 from tbl_user_business_view b
					where
					b.user_id=a.elPi_UserId and exists (select 1 from
					tbl_user_business_view b1 where b.busi_company_id =
					b1.busi_company_id and b1.user_id = #{userId}))
				</when>
				<when test="userLevel==5">
					and a.elPi_UserId=#{userId}
				</when>
			</choose>
			<if test="elPi_OwnCityCode != null and elPi_OwnCityCode != ''">
				and (elPi_OwnCityCode=#{elPi_OwnCityCode} or
				elPi_OwnProvinceCode =
				#{elPi_OwnCityCode})
			</if>
			)

			<if test="pileStatus != '999'">
				and pk_PowerStation not in (select
				elPi_RelevancePowerStation from
				tbl_electricpile a
				where elPi_State in
				(10, 15) and elPi_Binding=1
				and a.comm_status = '1'
				)
			</if>
		</where>
		union all
		select
		1
		from
		tbl_ElectricPile e
		<where>
			elPi_State in (10, 15) and elPi_Binding=0
			<!-- 权限控制 -->
			<choose>
				<when test="userLevel==3">
					and exists (select 1 from tbl_user_business_view b
					where
					b.user_id=e.elPi_UserId and exists (select 1 from
					tbl_user_business_view b1 where b.busi_company_id =
					b1.busi_company_id and b1.user_id = #{userId}))
				</when>
				<when test="userLevel==5">
					and e.elPi_UserId=#{userId}
				</when>
			</choose>
			<if test="elPi_OwnCityCode != null and elPi_OwnCityCode != ''">
				and (elPi_OwnCityCode=#{elPi_OwnCityCode} or
				elPi_OwnProvinceCode =
				#{elPi_OwnCityCode})
			</if>
			<if test="pileName != null and pileName != ''">
				and (elPi_ElectricPileName like
				concat('%',#{pileName},'%') or
				elPi_ElectricPileAddress like
				concat('%',#{pileName},'%'))
			</if>
			<if test="headStateStr != '999'">
				and exists (select 1 from tbl_electricpilehead p where
				p.pk_ElectricPile=e.pk_ElectricPile and
				FIND_IN_SET(p.ePHe_ElectricpileHeadState,#{headStateStr}))
				and
				e.comm_status = '1'
			</if>
			<if test="pileStatus != '999'">
				and e.comm_status = #{pileStatus}
			</if>
		</where>
		) as electricPileList
	</select>



	<select id="getElectricPileListByStationId" parameterType="map"
		resultType="ElectricPileMonitor">
		select
		elPi_ElectricPileName electricName,
		pk_ElectricPile electricId,
		elPi_ElectricPileAddress electricAddress,
		comm_status pileStatus,
		(case
		when exists (select 1 from tbl_electricpilehead a where
		a.pk_ElectricPile = e.pk_ElectricPile and a.ePHe_ElectricpileHeadState
		= '0') then 1 end) isFree,
		(case
		when exists (select 1 from tbl_electricpilehead a where
		a.pk_ElectricPile = e.pk_ElectricPile and a.ePHe_ElectricpileHeadState
		= '17') then 1 end) isWait,
		(case when exists (select 1 from
		tbl_electricpilehead a where
		a.pk_ElectricPile = e.pk_ElectricPile and
		a.ePHe_ElectricpileHeadState
		= '3') then 1 end) isBespeak,
		(case when
		exists (select 1 from tbl_electricpilehead a where
		a.pk_ElectricPile =
		e.pk_ElectricPile and a.ePHe_ElectricpileHeadState
		= '6') then 1 end)
		isCharge,
		(case when exists (select 1 from tbl_electricpilehead a where
		a.pk_ElectricPile = e.pk_ElectricPile and a.ePHe_ElectricpileHeadState
		= '9') then 1 end) isError
		from
		tbl_ElectricPile e
		<where>
			<if test="electricId != null and electricId != ''">
				elPi_RelevancePowerStation = ${electricId}
			</if>
		</where>
	</select>

	<!-- 故障电桩数量相关查询 -->
	<select id="pileErrorCount" resultType="hashmap">
		select count(1) count from tbl_electricpile t where
		t.elPi_State in
		('10','15') and exists (select 1 from tbl_electricpilehead a where
		a.ePHe_ElectricpileHeadState = '9' and a.pk_ElectricPile =
		t.pk_ElectricPile)
		<if test="pileName != null">
			and elpi_Electricpileaddress like
			CONCAT('%','${pileName}','%' )
		</if>
		<if test="electricSelProvince != null">
			and elPi_OwnProvinceCode = #{electricSelProvince}
		</if>
		<if test="elPi_OwnCityCode != null">
			and electricSelCity = #{elPi_OwnCityCode}
		</if>
		<if test="electricSelDistrict != null">
			and elPi_OwnCountyCode = #{electricSelDistrict}
		</if>
	</select>

	<!-- 故障电桩列表相关查询 -->
	<select id="queryErrorPile" parameterType="map" resultType="ElectricPileMonitor">
		select
		elPi_ElectricPileName electricName,
		pk_ElectricPile electricId,
		elPi_ElectricPileAddress electricAddress
		from
		tbl_ElectricPile t
		where
		exists (select 1 from tbl_electricpilehead a where
		a.ePHe_ElectricpileHeadState = '9' and a.pk_ElectricPile =
		t.pk_ElectricPile)
		<if test="pileName != null">
			and elpi_Electricpileaddress like
			CONCAT('%','${pileName}','%' )
		</if>
		<if test="electricSelProvince != null">
			and elPi_OwnProvinceCode = #{electricSelProvince}
		</if>
		<if test="elPi_OwnCityCode != null">
			and electricSelCity = #{elPi_OwnCityCode}
		</if>
		<if test="electricSelDistrict != null">
			and elPi_OwnCountyCode = #{electricSelDistrict}
		</if>
	</select>

	<!-- 电桩数量相关查询 -->
	<select id="getAllPileCount" parameterType="map" resultType="hashmap">
		select sum(count) pile_count from
		(select count(1) as count from
		tbl_electricpile t where t.elPi_State in
		('10','15') and t.elPi_Binding
		= '0'
		<if test="pileName != null">
			and elpi_Electricpileaddress like
			CONCAT('%','${pileName}','%' )
		</if>
		<if test="electricSelProvince != null">
			and elPi_OwnProvinceCode = #{electricSelProvince}
		</if>
		<if test="elPi_OwnCityCode != null">
			and electricSelCity = #{elPi_OwnCityCode}
		</if>
		<if test="electricSelDistrict != null">
			and elPi_OwnCountyCode = #{electricSelDistrict}
		</if>
		union all
		select count(1) as count from tbl_powerstation p where
		p.poSt_Status in
		('10','15')
		<if test="pileName != null">
			and poSt_Name like CONCAT('%','${pileName}','%' )
		</if>
		and pk_PowerStation in (select elPi_RelevancePowerStation from
		tbl_electricpile a
		where elPi_State in (10, 15) and elPi_Binding=1
		<if test="electricSelProvince != null and electricSelProvince != ''">
			and elPi_OwnProvinceCode=#{electricSelProvince}
		</if>
		<if test="electricSelCity != null and electricSelCity != ''">
			and elPi_OwnCityCode=#{electricSelCity}
		</if>
		<if test="electricSelDistrict != null and electricSelDistrict != ''">
			and elPi_OwnCountyCode=#{electricSelDistrict}
		</if>
		<if test="headState != null and headState != ''">
			and a.pk_ElectricPile in(select pk_ElectricPile from
			tbl_electricpilehead where ePHe_ElectricpileHeadState=#{headState})
		</if>

		)
		) a
	</select>

	<!-- 数据挖掘充电中的电桩数量相关查询 -->
	<select id="getChargingCount" resultType="hashmap">
		select sum(count) pile_count from
		(select count(1) as count from
		tbl_electricpile t where t.elPi_State in
		('10','15') and t.elPi_Binding
		= '0'
		and exists (select 1 from tbl_electricpilehead q where
		q.pk_ElectricPile
		= t.pk_ElectricPile and
		q.ePHe_ElectricpileHeadState='6')
		<if test="pileName != null">
			and elpi_Electricpileaddress like
			CONCAT('%','${pileName}','%' )
		</if>
		<if test="electricSelProvince != null">
			and elPi_OwnProvinceCode = #{electricSelProvince}
		</if>
		<if test="elPi_OwnCityCode != null">
			and electricSelCity = #{elPi_OwnCityCode}
		</if>
		<if test="electricSelDistrict != null">
			and elPi_OwnCountyCode = #{electricSelDistrict}
		</if>
		union all
		select count(1) as count from tbl_powerstation p where
		p.poSt_Status in
		('10','15')
		<if test="pileName != null">
			and poSt_Name like CONCAT('%','${pileName}','%' )
		</if>
		and pk_PowerStation in (select elPi_RelevancePowerStation from
		tbl_electricpile a
		where elPi_State in (10, 15) and elPi_Binding=1
		and
		exists (select 1 from tbl_electricpilehead q where q.pk_ElectricPile
		=
		a.pk_ElectricPile and q.ePHe_ElectricpileHeadState='6')
		<if test="electricSelProvince != null and electricSelProvince != ''">
			and elPi_OwnProvinceCode=#{electricSelProvince}
		</if>
		<if test="electricSelCity != null and electricSelCity != ''">
			and elPi_OwnCityCode=#{electricSelCity}
		</if>
		<if test="electricSelDistrict != null and electricSelDistrict != ''">
			and elPi_OwnCountyCode=#{electricSelDistrict}
		</if>
		<if test="headState != null and headState != ''">
			and a.pk_ElectricPile in(select pk_ElectricPile from
			tbl_electricpilehead where ePHe_ElectricpileHeadState=#{headState})
		</if>
		)
		) a
	</select>

	<!-- 数据挖掘预约中的电桩数量相关查询 -->
	<select id="getBespokeCount" resultType="hashmap">
		select sum(count) pile_count from
		(select count(1) as count from
		tbl_electricpile t where t.elPi_State in
		('10','15') and t.elPi_Binding
		= '0'
		and exists (select 1 from tbl_electricpilehead q where
		q.pk_ElectricPile
		= t.pk_ElectricPile and
		q.ePHe_ElectricpileHeadState='3')
		<if test="pileName != null">
			and elpi_Electricpileaddress like
			CONCAT('%','${pileName}','%' )
		</if>
		<if test="electricSelProvince != null">
			and elPi_OwnProvinceCode = #{electricSelProvince}
		</if>
		<if test="elPi_OwnCityCode != null">
			and electricSelCity = #{elPi_OwnCityCode}
		</if>
		<if test="electricSelDistrict != null">
			and elPi_OwnCountyCode = #{electricSelDistrict}
		</if>
		union all
		select count(1) as count from tbl_powerstation p where
		p.poSt_Status in
		('10','15')
		<if test="pileName != null">
			and poSt_Name like CONCAT('%','${pileName}','%' )
		</if>
		and pk_PowerStation in (select elPi_RelevancePowerStation from
		tbl_electricpile a
		where elPi_State in (10, 15) and elPi_Binding=1
		and
		exists (select 1 from tbl_electricpilehead q where q.pk_ElectricPile
		=
		a.pk_ElectricPile and q.ePHe_ElectricpileHeadState='3')
		<if test="electricSelProvince != null and electricSelProvince != ''">
			and elPi_OwnProvinceCode=#{electricSelProvince}
		</if>
		<if test="electricSelCity != null and electricSelCity != ''">
			and elPi_OwnCityCode=#{electricSelCity}
		</if>
		<if test="electricSelDistrict != null and electricSelDistrict != ''">
			and elPi_OwnCountyCode=#{electricSelDistrict}
		</if>
		<if test="headState != null and headState != ''">
			and a.pk_ElectricPile in(select pk_ElectricPile from
			tbl_electricpilehead where ePHe_ElectricpileHeadState=#{headState})
		</if>
		)
		) a
	</select>

	<!-- 数据挖掘分享点数量相关查询 -->
	<select id="getOnlineCount" resultType="hashmap">
		select sum(count) pile_count from
		(select count(1) as count from
		tbl_electricpile t where t.elPi_State = '15'
		and t.elPi_Binding = '0'
		<if test="pileName != null">
			and elpi_Electricpileaddress like
			CONCAT('%','${pileName}','%' )
		</if>
		<if test="electricSelProvince != null">
			and elPi_OwnProvinceCode = #{electricSelProvince}
		</if>
		<if test="elPi_OwnCityCode != null">
			and electricSelCity = #{elPi_OwnCityCode}
		</if>
		<if test="electricSelDistrict != null">
			and elPi_OwnCountyCode = #{electricSelDistrict}
		</if>
		union all
		select count(1) as count from tbl_powerstation p where
		p.poSt_Status in
		('10','15')
		<if test="pileName != null">
			and poSt_Name like CONCAT('%','${pileName}','%' )
		</if>
		and pk_PowerStation in (select elPi_RelevancePowerStation from
		tbl_electricpile a
		where elPi_State = '15' and elPi_Binding=1
		<if test="electricSelProvince != null and electricSelProvince != ''">
			and elPi_OwnProvinceCode=#{electricSelProvince}
		</if>
		<if test="electricSelCity != null and electricSelCity != ''">
			and elPi_OwnCityCode=#{electricSelCity}
		</if>
		<if test="electricSelDistrict != null and electricSelDistrict != ''">
			and elPi_OwnCountyCode=#{electricSelDistrict}
		</if>
		<if test="headState != null and headState != ''">
			and a.pk_ElectricPile in(select pk_ElectricPile from
			tbl_electricpilehead where ePHe_ElectricpileHeadState=#{headState})
		</if>
		)
		) a
	</select>

	<!-- 数据挖掘专属点数量相关查询 -->
	<select id="getOfflineCount" resultType="hashmap">
		select sum(count) pile_count from
		(select count(1) as count from
		tbl_electricpile t where t.elPi_State = '10'
		and t.elPi_Binding = '0'
		<if test="pileName != null">
			and elpi_Electricpileaddress like
			CONCAT('%','${pileName}','%' )
		</if>
		<if test="electricSelProvince != null">
			and elPi_OwnProvinceCode = #{electricSelProvince}
		</if>
		<if test="elPi_OwnCityCode != null">
			and electricSelCity = #{elPi_OwnCityCode}
		</if>
		<if test="electricSelDistrict != null">
			and elPi_OwnCountyCode = #{electricSelDistrict}
		</if>
		union all
		select count(1) as count from tbl_powerstation p where
		p.poSt_Status in
		('10','15')
		<if test="pileName != null">
			and poSt_Name like CONCAT('%','${pileName}','%' )
		</if>
		and pk_PowerStation in (select elPi_RelevancePowerStation from
		tbl_electricpile a
		where elPi_State = '10' and elPi_Binding=1
		<if test="electricSelProvince != null and electricSelProvince != ''">
			and elPi_OwnProvinceCode=#{electricSelProvince}
		</if>
		<if test="electricSelCity != null and electricSelCity != ''">
			and elPi_OwnCityCode=#{electricSelCity}
		</if>
		<if test="electricSelDistrict != null and electricSelDistrict != ''">
			and elPi_OwnCountyCode=#{electricSelDistrict}
		</if>
		<if test="headState != null and headState != ''">
			and a.pk_ElectricPile in(select pk_ElectricPile from
			tbl_electricpilehead where ePHe_ElectricpileHeadState=#{headState})
		</if>
		)
		) a
	</select>

	<!-- 数据挖掘枪头详情相关查询 -->
	<select id="getHeadDetailByPoint" parameterType="hashmap"
		resultType="hashmap">
		SELECT
		a.pk_ElectricPile,
		a.elPi_ElectricPileCode,
		b.pk_ElectricpileHead,
		b.ePHe_ElectricpileHeadId,
		a.ep_num,
		a.comm_status,
		(
		<!-- CASE WHEN a.elPi_PowerSize = '6' THEN '3.5kw' WHEN a.elPi_PowerSize 
			= '15' THEN '7kw' WHEN a.elPi_PowerSize = '172' THEN '30kw' WHEN a.elPi_PowerSize 
			= '170' THEN '60kw' WHEN a.elPi_PowerSize = '171' THEN '37.5kw' WHEN a.elPi_PowerSize 
			= '169' THEN '60.5kw' WHEN a.elPi_PowerSize = '43' THEN '120kw' END -->
		select c.coCo_Content from tbl_configcontent
		c where
		c.pk_ConfigContent=a.elPi_PowerSize) elPi_PowerSize,
		a.elPi_ChargingMode,
		b.ePHe_ElectricpileHeadState,
		b.ePHe_ElectricpileHeadName
		FROM
		tbl_electricpile a,
		tbl_electricpilehead b
		WHERE
		a.pk_ElectricPile = b.pk_ElectricPile
		and
		b.delete_flag = '0'
		<if test="eType == 1">
			and a.pk_ElectricPile = #{eId}
		</if>
		<if test="eType == 2">
			and a.elPi_RelevancePowerStation = #{eId}
		</if>
		ORDER BY a.ep_num
	</select>

	<!-- 数据挖掘枪头详情相关查询 -->
	<select id="getElectricPileByCode" parameterType="hashmap"
		resultType="hashmap">
		SELECT
		a.pk_ElectricPile,
		a.elPi_Longitude,
		a.elPi_Latitude,
		a.elPi_ElectricPileName,
		a.elPi_ElectricPileAddress,
		(select t.city_name from tb_m_city t where t.city_id = a.elPi_OwnCityCode) city_name
		FROM
		tbl_electricpile a
		WHERE
		a.elPi_ElectricPileCode = #{eCode}
	</select>
	<!-- 枪头累计充电统计 -->
	<select id="getChargeStatics_01" parameterType="hashmap"
		resultType="hashmap">
		SELECT
		IFNULL(left(min(a.chOr_Createdate),10),'0000-00-00')  ch01,
		IFNULL(count(1),0)
		chCount01,
		IFNULL(sum(a.chOr_Moeny),0) chMoney01,
		IFNULL(sum(a.chOr_QuantityElectricity),0) chQuantity01
		FROM
		tbl_chargingorder a,
		tbl_electricpile b
<!-- 		tbl_electricpilehead c -->
		WHERE
		a.chOr_PileNumber = b.elPi_ElectricPileCode
<!-- 		AND b.pk_ElectricPile = -->
<!-- 		c.pk_ElectricPile -->
		AND a.chOr_ChargingStatus >= 2
	    AND a.chOr_ChargingStatus!=4
		AND
		b.elPi_ElectricPileCode = #{eCode}
		AND a.chOr_Muzzle = #{headId}
<!-- 		AND c.ePHe_ElectricpileHeadId -->
<!-- 		=#{headId} -->

	</select>
	<!-- 本年枪口充电统计 -->
	<select id="getChargeStatics_02" parameterType="hashmap"
		resultType="hashmap">
		SELECT
		IFNULL(left(a.chOr_Createdate,4),0) ch01,
		IFNULL(count(1),0) chCount01,
		IFNULL(sum(a.chOr_Moeny),0) chMoney01,
		IFNULL(sum(a.chOr_QuantityElectricity),0) chQuantity01
		FROM
		tbl_chargingorder a,
		tbl_electricpile b
		WHERE
		a.chOr_PileNumber = b.elPi_ElectricPileCode
		AND a.chOr_ChargingStatus >= 2
		AND a.chOr_ChargingStatus!=4
		AND
		b.elPi_ElectricPileCode = #{eCode}
		AND a.chOr_Muzzle = #{headId}
		AND left(a.chOr_Createdate,4) = left(sysdate(),4)
		group by
		left(a.chOr_Createdate,4)
		order by left(a.chOr_Createdate,4);
	</select>
	<!-- 本月枪口充电统计 -->
	<select id="getChargeStatics_03" parameterType="hashmap"
		resultType="hashmap">
		SELECT
		IFNULL(left(a.chOr_Createdate,7),0) ch01,
		IFNULL(count(1),0) chCount01,
		IFNULL(sum(a.chOr_Moeny),0) chMoney01,
		IFNULL(sum(a.chOr_QuantityElectricity),0) chQuantity01
		FROM
		tbl_chargingorder a,
		tbl_electricpile b
		WHERE
		a.chOr_PileNumber = b.elPi_ElectricPileCode
		AND a.chOr_ChargingStatus >= 2
		AND a.chOr_ChargingStatus!=4
		AND
		b.elPi_ElectricPileCode = #{eCode}
		AND a.chOr_Muzzle = #{headId}
		AND left(a.chOr_Createdate,7) = left(sysdate(),7)
		group by
		left(a.chOr_Createdate,7)
		order by left(a.chOr_Createdate,7);
	</select>
	<!-- 当天枪口充电统计 -->
	<select id="getChargeStatics_04" parameterType="hashmap"
		resultType="hashmap">
		SELECT
		IFNULL(left(a.chOr_Createdate,10),0) ch01,
		IFNULL(count(1),0) chCount01,
		IFNULL(sum(a.chOr_Moeny),0) chMoney01,
		IFNULL(sum(a.chOr_QuantityElectricity),0) chQuantity01
		FROM
		tbl_chargingorder a,
		tbl_electricpile b
		WHERE
		a.chOr_PileNumber = b.elPi_ElectricPileCode
		AND a.chOr_ChargingStatus >= 2
		AND a.chOr_ChargingStatus!=4
		AND
		b.elPi_ElectricPileCode = #{eCode}
		AND a.chOr_Muzzle = #{headId}
		AND left(a.chOr_Createdate,10) = left(sysdate(),10);
	</select>
	<!-- 查询电桩编号、充电统计中数据为空时查询该sql -->
	<select id="getChargeStatics_demo" parameterType="hashmap"
		resultType="hashmap">
		SELECT
		'0' ch01,
		'0' chCount01,
		'0.00' chMoney01,
		'0.00' chQuantity01,
		t.pk_ElectricPile pkId
		FROM
		tbl_electricpile t where t.elPi_ElectricPileCode=#{eCode}
	</select>
</mapper>